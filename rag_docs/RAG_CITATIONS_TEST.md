# Тестирование RAG с цитированием источников

## Описание
Этот документ содержит 5 тестовых вопросов для проверки функционала RAG с обязательным цитированием источников.

## ⚠️ ВАЖНО: Улучшения День 19
После первого неудачного теста (модель отвечала "информация не найдена") были внесены значительные улучшения:
1. **Улучшенный системный промпт** - более директивный с примерами
2. **Визуально выделенный контекст** - с эмодзи и форматированием
3. **Явные инструкции** - что делать и чего не делать

См. подробности в `RAG_IMPROVEMENTS.md`

## Команда для тестирования
```bash
/testRagCitations <вопрос>
```

## Критерии оценки
1. **Наличие цитат**: Каждый ответ должен содержать ссылки на источники в формате `[источник: <файл>, строки <начало>-<конец>]`
2. **Отсутствие галлюцинаций**: Ответы должны быть основаны только на информации из документации
3. **Релевантность**: Ответы должны точно отвечать на вопрос

---

## Тестовые вопросы

### Вопрос 1: Какие MCP серверы используются в проекте?
**Ожидаемый результат:**
- Ответ должен упомянуть HTTP MCP серверы (weather, reminders, chuck) и Stdio MCP сервер (docker)
- Каждый сервер должен быть подкреплен ссылкой на источник
- Не должно быть упоминаний серверов, которых нет в документации

**Команда:**
```
/testRagCitations Какие MCP серверы используются в проекте?
```

---

### Вопрос 2: Какая модель используется для embeddings?
**Ожидаемый результат:**
- Ответ должен указать модель `nomic-embed-text` от Ollama
- Должна быть ссылка на строки, где это упоминается
- Не должно быть упоминаний других моделей для embeddings (например, GigaChat)

**Команда:**
```
/testRagCitations Какая модель используется для embeddings?
```

---

### Вопрос 3: Какие команды бота связаны с RAG?
**Ожидаемый результат:**
- Ответ должен перечислить команды: /createEmbeddings, /testRag, /compareRag, /testRagCitations, /setThreshold
- Каждая команда должна быть подкреплена цитатой
- Не должно быть выдуманных команд

**Команда:**
```
/testRagCitations Какие команды бота связаны с RAG?
```

---

### Вопрос 4: Какой порог релевантности используется по умолчанию для фильтрации RAG?
**Ожидаемый результат:**
- Ответ должен указать значение 0.5 (50%)
- Должна быть ссылка на соответствующий раздел документации
- Не должно быть других значений, не упомянутых в документации

**Команда:**
```
/testRagCitations Какой порог релевантности используется по умолчанию для фильтрации RAG?
```

---

### Вопрос 5: Как работает автоматическое суммирование истории сообщений?
**Ожидаемый результат:**
- Ответ должен упомянуть лимит в 20 сообщений
- Должна быть информация о температуре 0.0 для суммаризации
- Упоминание лимита в 3000 символов для сжатой истории
- Все факты должны иметь ссылки на источники

**Команда:**
```
/testRagCitations Как работает автоматическое суммирование истории сообщений?
```

---

## Анализ результатов

### Метрики для оценки:
1. **Процент ответов с цитатами**: Сколько из 5 ответов содержат хотя бы одну ссылку на источник
2. **Среднее количество цитат на ответ**: Насколько детально модель цитирует источники
3. **Наличие галлюцинаций**: Содержат ли ответы информацию, не подтвержденную документацией
4. **Точность ссылок**: Соответствуют ли указанные строки реальному расположению информации

### Ожидаемые результаты:
- **100% ответов с цитатами** (5 из 5)
- **Минимум 2-3 цитаты на ответ**
- **0 галлюцинаций** (все факты из документации)
- **Высокая точность ссылок** (±5 строк от реального расположения)

---

## Сравнение с предыдущими подходами

### Без RAG (обычный ответ):
- Модель может галлюцинировать
- Нет ссылок на источники
- Ответы могут быть неточными

### С RAG без фильтра (текущий подход):
- Модель использует контекст из документации
- Меньше галлюцинаций, но возможны
- Нет обязательных ссылок на источники

### С RAG + цитирование (новый подход):
- Модель использует только информацию из документации
- **Обязательные ссылки на источники**
- Минимум галлюцинаций
- Прозрачность и проверяемость ответов

---

## Примечания

1. Перед тестированием убедитесь, что:
   - Ollama запущена (`ollama list` должен показывать `nomic-embed-text` и `qwen3:4b`)
   - Созданы embeddings командой `/createEmbeddings`
   - Файл `rag_docs/readme.md` содержит актуальную документацию проекта

2. Для лучших результатов:
   - Используйте порог релевантности 0.5-0.6
   - Убедитесь, что документация полная и актуальная
   - Проверяйте, что модель qwen3:4b установлена (`ollama pull qwen3:4b`)

3. Если модель не цитирует источники:
   - Проверьте системный промпт `RagWithCitationsRole`
   - Убедитесь, что контекст содержит инструкции о цитировании
   - Попробуйте переформулировать вопрос
