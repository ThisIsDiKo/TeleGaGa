# MCP Integration с GigaChat

## Обзор

Проект TeleGaGa теперь поддерживает интеграцию с Model Context Protocol (MCP) сервером "everything". Это позволяет GigaChat LLM использовать внешние инструменты через function calling.

## Что было реализовано

### 1. Расширение моделей данных (GigaModels.kt)

Добавлена поддержка GigaChat API function calling:

```kotlin
// Новые поля в GigaChatChatRequest
val functions: List<GigaChatFunction>? = null
val functionCall: String? = null // "auto" | "none"

// Новые классы для описания функций
data class GigaChatFunction(...)
data class GigaChatFunctionParameters(...)
data class GigaChatFunctionCall(...)
```

### 2. ToolCallHandler (ru/dikoresearch/domain/ToolCallHandler.kt)

Новый компонент для обработки вызовов инструментов:

- `getAvailableFunctions()` - получает список MCP инструментов и конвертирует их в формат GigaChat
- `executeFunctionCall()` - выполняет вызов инструмента через MCP и форматирует результат с визуальными метками
- `convertMcpToolToGigaChatFunction()` - преобразует MCP Tool в GigaChat Function
- `formatToolResult()` - форматирует результат с визуальными границами

### 3. Обновленный GigaChatClient

Метод `chatCompletion()` теперь принимает:
- `functions: List<GigaChatFunction>?` - список доступных функций
- `functionCall: String?` - режим вызова функций ("auto" для автоматического выбора)

### 4. Улучшенный ChatOrchestrator

Основная логика обработки tool calls:
- Автоматически получает список MCP инструментов при включенном режиме
- Реализует цикл tool calling с максимум 5 итерациями
- Обрабатывает `finish_reason: "function_call"` от GigaChat
- Добавляет результаты вызова функций в историю диалога
- Визуально отображает использование MCP инструментов

### 5. Системные промпты

Добавлен новый промпт `McpEnabledRole` в Main.kt:
- Объясняет модели доступные категории инструментов (fetch, search, file operations, memory)
- Даёт рекомендации когда использовать инструменты
- Приводит примеры корректного использования

### 6. Новые команды бота

#### `/enableMcp`
Активирует MCP режим, устанавливая специальный системный промпт и включая передачу функций в запросы к GigaChat.

#### `/listTools`
Показывает список доступных MCP инструментов от сервера "everything".

## Архитектура решения

```
User Message
     ↓
TelegramBotService
     ↓
ChatOrchestrator.processMessage()
     ↓
┌────────────────────────────────────────┐
│  Цикл Tool Calling (до 5 итераций)    │
│                                        │
│  1. ToolCallHandler.getAvailableFunctions()
│     ↓                                  │
│  2. GigaChatClient.chatCompletion()    │
│     (с functions + functionCall="auto")│
│     ↓                                  │
│  3. Если finish_reason="function_call":│
│     - ToolCallHandler.executeFunctionCall()
│     - McpService.callTool()            │
│     - Добавить результат в историю     │
│     - Повторить запрос к GigaChat      │
│                                        │
│  4. Иначе: вернуть финальный ответ    │
└────────────────────────────────────────┘
     ↓
Форматирование ответа с визуальными метками
     ↓
Отправка в Telegram
```

## Визуальное отображение

Когда модель использует MCP инструменты, ответ форматируется следующим образом:

```
⚡ MCP TOOLS АКТИВНЫ ⚡

*** GigaChat T = 0.87 ***
Использованы MCP инструменты:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[MCP Tool: fetch]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

<результат работы инструмента>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Итоговый ответ:

<ответ модели с анализом результата>

▶ MCP инструменты использованы
Отправлены токены: 1234
Получены токены: 567
Оплачены токены: 1801
```

## Поддерживаемые MCP инструменты

Сервер "everything" предоставляет следующие категории инструментов:

1. **fetch** - получение данных из интернета
2. **search** - поиск информации
3. **file operations** - чтение и работа с файлами
4. **memory** - сохранение и извлечение контекста между сессиями

Полный список доступен через команду `/listTools` в боте.

## Примеры использования

### Пример 1: Получение актуальных данных

```
User: Какая сейчас погода в Москве?

Bot активирует fetch инструмент →
MCP сервер получает данные →
GigaChat анализирует результат →
Пользователь видит ответ с меткой [MCP Tool: fetch]
```

### Пример 2: Поиск информации

```
User: Найди последние новости про SpaceX

Bot активирует search инструмент →
MCP сервер выполняет поиск →
GigaChat обрабатывает результаты →
Пользователь получает структурированный ответ
```

## Технические детали

### Ограничения

- Максимум 5 итераций tool calling в одном запросе (защита от бесконечных циклов)
- Лимит длины ответа Telegram: 3800 символов
- MCP сервер должен быть запущен и доступен при старте бота

### Обработка ошибок

- Если MCP сервер недоступен, бот работает в обычном режиме без инструментов
- Ошибки вызова инструментов логируются и передаются модели для обработки
- При ошибке парсинга аргументов используется пустая Map

### Thread Safety

- `ToolCallHandler` использует MCP SDK который обеспечивает потокобезопасность
- Все вызовы MCP выполняются через suspend функции

## Конфигурация

Для работы MCP интеграции требуется:

1. Node.js и npx установлены в системе
2. Доступ к пакету `@modelcontextprotocol/server-everything`
3. MCP сервис инициализируется автоматически при старте бота

## Зависимости

```kotlin
// build.gradle.kts
implementation("io.modelcontextprotocol:kotlin-sdk:0.8.3")
```

## Дальнейшее развитие

Возможные улучшения:

1. Добавить кеширование списка инструментов
2. Реализовать конфигурируемое количество итераций tool calling
3. Добавить метрики использования инструментов
4. Поддержка пользовательских MCP серверов
5. Фильтрация доступных инструментов по категориям

## Troubleshooting

### Проблема: MCP инструменты не работают

**Решение:**
1. Проверьте что MCP сервис инициализирован: смотрите логи при старте бота
2. Выполните `/listTools` - должен вернуться список инструментов
3. Активируйте MCP режим через `/enableMcp`
4. Проверьте что используется модель GigaChat-Pro или GigaChat-Plus (они поддерживают function calling)

### Проблема: Модель не вызывает инструменты

**Решение:**
1. Убедитесь что активирован McpEnabledRole через `/enableMcp`
2. Попробуйте более явные запросы: "Получи данные с сайта..." вместо "Расскажи про..."
3. Проверьте temperature - слишком низкая может снизить вероятность вызова функций

### Проблема: Ошибки при вызове инструментов

**Решение:**
1. Проверьте логи сервера на предмет ошибок MCP SDK
2. Убедитесь что npx процесс запущен: `ps aux | grep npx`
3. Перезапустите бота для переинициализации MCP сервиса

## Источники

- [GigaChat REST API Documentation](https://developers.sber.ru/docs/ru/gigachat/api/reference/rest/gigachat-api)
- [GigaChat Function Calling Tutorial](https://habr.com/ru/articles/806627/)
- [MCP Protocol Documentation](https://github.com/modelcontextprotocol)
- [Everything MCP Server](https://github.com/modelcontextprotocol/servers/tree/main/src/everything)
